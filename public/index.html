<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <link rel="stylesheet" href="style.css" />
        <title>Trivia Game</title>
    </head>
    <body>
        <h1>Trivia Game</h1>
        <!--Subjects-->
        <div class="category-row" id="subject-buttons">
            <button class="category-btn">History</button>
            <button class="category-btn">Geography</button>
            <button class="category-btn">Computer</button>
        </div>

        <!--Levels-->
        <div class="level-row" id="level-buttons">
            <button class="level-btn">100</button>
            <button class="level-btn">200</button>
            <button class="level-btn">300</button>
            <button class="level-btn">400</button>
            <button class="level-btn">500</button>
        </div>

        <!--Lives-->
        <div id="lives-counter">Lives left: 4</div>

        <!--Message to User-->
        <div id="message-box"></div>

        <!--Questions-->
        <div id="question-container"></div>

        <script>

            let gameEnded = sessionStorage.getItem('gameEnded') === 'true';
            // When user сhooses a subject
            let selectedSubject = null;

            resetLevelButtons();

            document.querySelectorAll('.category-btn').forEach(button => {
            button.addEventListener('click', () => {
                if (gameEnded) return;

                // Save the selected subject text
                selectedSubject = button.textContent;
                
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                button.classList.add('selected');
                document.getElementById('message-box').textContent = '';

                // Clear previously displayed question (if any)
                document.getElementById('question-container').innerHTML = '';
                
                // Fetch-request: theme availability check
                fetch(`/check-subject?subject=${selectedSubject}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.available) {
                        alert(`All questions on ${selectedSubject} were answered.\nPlease select another subject.`);
                        return;
                    }
                    // Color levels in green and red according to availability
                    updateLevelButtons(data.availableLevels);
                })
                .catch(err => console.error(err));
            });
            });

            // When user сhooses a level
            document.querySelectorAll('.level-btn').forEach(button => {
            button.addEventListener('click', () => {

                if (gameEnded) return;

                // If the subject is not selected
                if (!selectedSubject) {
                    alert('Please choose a subject first.');
                    return;
                }
                
                // Save the selected level text
                const level = button.textContent;

                // CLEARING & COLORING :)
                document.querySelectorAll('.level-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                button.classList.add('selected');


                // Fetch-request: question availability check
                fetch(`/check-level?subject=${selectedSubject}&level=${level}`)
                .then(res => res.json())
                .then(data => {
                    if (data.available) {

                        // Display the question
                        document.getElementById('question-container').innerHTML = `
                            <h2>${data.question}</h2>
                            <button class="answer-btn" data-option="a">${data.options.a}</button>
                            <button class="answer-btn" data-option="b">${data.options.b}</button>
                            <button class="answer-btn" data-option="c">${data.options.c}</button>
                            <button class="answer-btn" data-option="d">${data.options.d}</button>
                            `;

                            document.querySelectorAll('.answer-btn').forEach(button => {
                                button.addEventListener('click', (e) => {
                                    const selectedAnswer = e.target.dataset.option;
             
                                    // Clear previously displayed question (if any)
                                    document.getElementById('question-container').innerHTML = '';    
                                    resetLevelButtons();


                                    document.querySelectorAll('.level-btn').forEach(btn => {
                                        btn.disabled = true;
                                    });

                                    // Fetch-request: checking answer
                                    fetch(`/check-answer?subject=${selectedSubject}&level=${level}&correctAnswer=${selectedAnswer}`)
                                    .then(res => res.json())
                                    .then(data => {
                                        // Back to "main menu"
                                        selectedSubject = null;
                                        document.querySelectorAll('.category-btn').forEach(btn => {
                                            btn.classList.remove('selected');
                                        });

                                        updateLives(data.mistakes);

                                        if (data.correctAns) {
                                            showMessage(`✅ Correct! You have ${data.points} points.`, true);
                                        } else {
                                            if (data.gameOver || data.mistakes >= 4) {
                                                gameEnded = true;
                                               
                                                sessionStorage.setItem('points', data.points);
                                                sessionStorage.setItem('gameEnded', 'true');

                                                if (data.mistakes >= 4) {
                                                    showMessage(`❌ You have 4 mistakes! Game over.`, false);
                                                    sessionStorage.setItem('endReason', 'mistakes');
                                                } else {
                                                    showMessage("🎉 All questions have been answered! The game is over.", true);
                                                    sessionStorage.setItem('endReason', 'completed');
                                                }

                                                window.location.href = '/gameOver.html'; 
                                                return;
                                            }
                                            else {
                                                showMessage(`❌ Incorrect. You have ${data.mistakes} mistake(s).`, false);
                                            }
                                        } 

                                        if (data.gameOver) {
                                            alert("All questions have been answered! The game is over.");

                                            sessionStorage.setItem('points', data.points);
                                            sessionStorage.setItem('gameEnded', 'true');
                                            sessionStorage.setItem('endReason', 'completed');

                                            window.location.href = '/gameOver.html';
                                            return;
                                        }

                                        resetLevelButtons();
                                        
                                    })
                                    .catch(err => console.error(err));
                                });
                                });
                    } else {
                    alert(`This question has been answered. Try another one`);
                    }
                })
                .catch(err => console.error(err));
            });
            });

            // CLEARING & COLORING function :)
            function updateLevelButtons(availableLevels) {
                document.querySelectorAll('.level-btn').forEach(btn => {
                    const level = parseInt(btn.textContent);

                    btn.classList.remove('level-available', 'level-unavailable', 'selected');

                    if (availableLevels.includes(level)) {
                        btn.disabled = false;
                        btn.classList.add('level-available');
                    } else {
                        btn.disabled = true;
                        btn.classList.add('level-unavailable');
                    }
                });
            }

            function resetLevelButtons() {
                document.querySelectorAll('.level-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.remove('level-available', 'level-unavailable', 'selected');
                    btn.classList.add('level-unavailable');
                });
            }

            function updateLives(mistakes) {
                const livesLeft = 4 - mistakes;
                document.getElementById('lives-counter').textContent = `Lives left: ${livesLeft}`;
            }

            function showMessage(message, isCorrect) {
                const box = document.getElementById('message-box');
                box.textContent = message;
                box.style.color = isCorrect ? 'green' : 'red';
            }


        </script>
    </body>
</html>